# traceability-matrix.yaml
# Generated by Validator Agent
# Purpose: Complete traceability mapping from domain truth to code
# Schema: bmad-core/schemas/validation/traceability-matrix.schema.yaml (planned)

metadata:
  version: "1.0.0"
  generated_date: "{{GENERATED_DATE}}"
  project_name: "{{PROJECT_NAME}}"
  coverage_target: 100  # % of requirements that must be traceable

traceability_chains:
  - chain_id: "TRACE-001"
    name: "{{REQUIREMENT_NAME}}"

    domain_truth:
      - fact_id: "FACT-001"
        type: "{{TYPE}}"  # [concept, rule, functional_requirement]
        description: "{{DESCRIPTION}}"
        source: "domain-truth.yaml#{{ANCHOR}}"

    requirements:
      - requirement_id: "FR-001"
        type: "functional_requirement"  # [functional, non_functional]
        description: "{{DESCRIPTION}}"
        source: "prd.md#{{SECTION}}"
        traces_to_domain: ["FACT-001"]

    architecture:
      - design_id: "DESIGN-001"
        component: "{{COMPONENT_NAME}}"
        description: "{{DESCRIPTION}}"
        source: "architecture.md#{{SECTION}}"
        implements_requirements: ["FR-001"]

    stories:
      - story_id: "{{STORY_ID}}"
        title: "{{STORY_TITLE}}"
        source: "docs/stories/{{STORY_FILE}}"
        implements_requirements: ["FR-001"]
        implements_design: ["DESIGN-001"]

    code:
      - file_path: "{{FILE_PATH}}"
        function_or_class: "{{NAME}}"
        line_range: "{{START}}-{{END}}"
        implements_story: "{{STORY_ID}}"
        implements_design: ["DESIGN-001"]

    tests:
      - test_dataset_id: "TEST-DATASET-001"
        test_file: "{{TEST_FILE}}"
        test_function: "{{TEST_FUNCTION}}"
        validates_domain: ["FACT-001"]
        validates_requirement: ["FR-001"]
        validates_code: ["{{FILE_PATH}}"]

    validation_status:
      complete: true
      all_levels_present: true
      bidirectional_verified: true
      tests_passing: true

  # Add more traceability chains

coverage_analysis:
  domain_truth_coverage:
    total_facts: {{TOTAL_FACTS}}
    covered_facts: {{COVERED_FACTS}}
    uncovered_facts: []  # List of fact IDs not covered
    coverage_percentage: {{COVERAGE_PCT}}

  requirements_coverage:
    total_requirements: {{TOTAL_FRS}}
    covered_requirements: {{COVERED_FRS}}
    uncovered_requirements: []  # List of FR IDs not covered
    coverage_percentage: {{COVERAGE_PCT}}

  architecture_coverage:
    total_components: {{TOTAL_COMPS}}
    covered_components: {{COVERED_COMPS}}
    uncovered_components: []
    coverage_percentage: {{COVERAGE_PCT}}

  code_coverage:
    lines_of_code: {{LOC}}
    covered_lines: {{COVERED_LOC}}
    coverage_percentage: {{COVERAGE_PCT}}

  test_coverage:
    total_tests: {{TOTAL_TESTS}}
    passing_tests: {{PASSING}}
    failing_tests: {{FAILING}}
    pass_rate: {{PASS_RATE}}

gaps_and_orphans:
  orphaned_requirements:  # Requirements with no domain truth trace
    - requirement_id: "{{FR_ID}}"
      reason: "{{REASON}}"

  orphaned_code:  # Code with no requirement trace
    - file_path: "{{FILE_PATH}}"
      reason: "{{REASON}}"

  missing_tests:  # Requirements with no test datasets
    - requirement_id: "{{FR_ID}}"
      reason: "{{REASON}}"

  incomplete_chains:  # Chains missing levels
    - chain_id: "{{CHAIN_ID}}"
      missing_levels: ["{{LEVEL}}"]

bidirectional_validation:
  forward_traceability:  # Domain → Requirements → Architecture → Code → Tests
    validated: true
    issues: []

  backward_traceability:  # Code → Architecture → Requirements → Domain
    validated: true
    issues: []

  consistency_check:
    all_forward_links_have_backward_links: true
    all_backward_links_have_forward_links: true

validation_evidence:
  last_validation_date: "{{DATE}}"
  validation_tool: "Validator Agent"
  validation_report: "{{REPORT_PATH}}"

# [[LLM: INSTRUCTIONS FOR VALIDATOR AGENT]]
# [[LLM: When generating this matrix:]]
# [[LLM: 1. Create a complete chain for EVERY domain fact and requirement]]
# [[LLM: 2. Verify bidirectional links (forward AND backward)]]
# [[LLM: 3. Identify and list ALL gaps and orphans]]
# [[LLM: 4. Calculate coverage percentages for each level]]
# [[LLM: 5. Ensure 100% requirement coverage target]]
# [[LLM: 6. Link to validation-chain-proof documents for evidence]]
